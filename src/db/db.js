// /src/db/db.js
import Dexie from "dexie";

export const db = new Dexie("talentflowDB");

// ✅ bump version to 6 to include new job fields
db.version(6).stores({
  jobs: "++id,slug,title,description,skills,experienceLevel,salaryRange,location,status,order,tags",
  candidates: "++id,name,email,jobId,stage",
  timelines: "++id,candidateId,event,createdAt",
  assessments: "++id,jobId,title,questions",
  submissions: "++id,jobId,assessmentId,candidateId,answers,submittedAt",
  assessmentDrafts: "jobId,title,questions",
});

// ---- Seeds ----

// Seed jobs
export async function seedJobs() {
  const count = await db.jobs.count();
  if (count === 0) {
    await db.jobs.bulkAdd([
      {
        title: "Frontend Engineer",
        slug: "frontend-engineer",
        description: "We are looking for a skilled Frontend Engineer to join our team. You will be responsible for building user-facing features and ensuring a great user experience.",
        skills: ["React", "TypeScript", "CSS", "HTML", "JavaScript"],
        experienceLevel: "mid",
        salaryRange: "$80,000 - $120,000",
        location: "San Francisco, CA",
        status: "active",
        order: 1,
        tags: ["react", "frontend", "full-time"],
      },
      {
        title: "Backend Engineer",
        slug: "backend-engineer",
        description: "Join our backend team to build scalable APIs and services. You will work with modern technologies and contribute to our microservices architecture.",
        skills: ["Node.js", "Python", "PostgreSQL", "AWS", "Docker"],
        experienceLevel: "senior",
        salaryRange: "$100,000 - $150,000",
        location: "Remote",
        status: "active",
        order: 2,
        tags: ["node", "backend", "remote"],
      },
      // --- 40 New Jobs Start Here ---
      {
        title: "Full Stack Developer",
        slug: "full-stack-developer",
        description: "Seeking a versatile Full Stack Developer to work on both our client and server-side applications. Experience with MERN stack is a plus.",
        skills: ["React", "Node.js", "MongoDB", "Express", "GraphQL"],
        experienceLevel: "mid",
        salaryRange: "$95,000 - $135,000",
        location: "New York, NY",
        status: "active",
        order: 3,
        tags: ["full-stack", "mern", "javascript"],
      },
      {
        title: "UI/UX Designer",
        slug: "ui-ux-designer",
        description: "Create intuitive and beautiful user interfaces. You will be responsible for the entire design process, from wireframes to high-fidelity mockups.",
        skills: ["Figma", "Sketch", "Adobe XD", "User Research", "Prototyping"],
        experienceLevel: "mid",
        salaryRange: "$75,000 - $110,000",
        location: "Austin, TX",
        status: "active",
        order: 4,
        tags: ["design", "ui", "ux", "creative"],
      },
      {
        title: "Product Manager",
        slug: "product-manager",
        description: "Define product vision, strategy, and roadmap. You will work closely with engineering, design, and marketing to deliver impactful products.",
        skills: ["Agile", "Roadmapping", "JIRA", "Market Research", "Stakeholder Management"],
        experienceLevel: "senior",
        salaryRange: "$120,000 - $160,000",
        location: "Remote",
        status: "active",
        order: 5,
        tags: ["product", "management", "strategy", "remote"],
      },
      {
        title: "Data Scientist",
        slug: "data-scientist",
        description: "Leverage data to drive business insights. Build machine learning models and perform statistical analysis to solve complex problems.",
        skills: ["Python", "R", "SQL", "TensorFlow", "Scikit-learn"],
        experienceLevel: "senior",
        salaryRange: "$130,000 - $180,000",
        location: "Seattle, WA",
        status: "active",
        order: 6,
        tags: ["data-science", "machine-learning", "analytics"],
      },
      {
        title: "DevOps Engineer",
        slug: "devops-engineer",
        description: "Automate and streamline our operations and processes. Build and maintain tools for CI/CD, and manage our cloud infrastructure.",
        skills: ["AWS", "Kubernetes", "Docker", "Terraform", "Jenkins"],
        experienceLevel: "mid",
        salaryRange: "$110,000 - $145,000",
        location: "Boston, MA",
        status: "active",
        order: 7,
        tags: ["devops", "ci-cd", "cloud", "infrastructure"],
      },
      {
        title: "Mobile Developer (iOS)",
        slug: "mobile-developer-ios",
        description: "Develop and maintain our native iOS application. A deep understanding of Swift and the iOS ecosystem is required.",
        skills: ["Swift", "SwiftUI", "Xcode", "Core Data", "Combine"],
        experienceLevel: "mid",
        salaryRange: "$100,000 - $140,000",
        location: "Remote",
        status: "active",
        order: 8,
        tags: ["ios", "mobile", "swift", "remote"],
      },
      {
        title: "QA Automation Engineer",
        slug: "qa-automation-engineer",
        description: "Design and implement automated testing frameworks to ensure the quality of our software releases.",
        skills: ["Selenium", "Cypress", "Jest", "Playwright", "CI/CD"],
        experienceLevel: "mid",
        salaryRange: "$85,000 - $115,000",
        location: "Chicago, IL",
        status: "active",
        order: 9,
        tags: ["qa", "testing", "automation"],
      },
      {
        title: "Technical Writer",
        slug: "technical-writer",
        description: "Create clear, concise, and comprehensive documentation for our APIs, SDKs, and internal tools.",
        skills: ["Markdown", "Git", "API Documentation", "Confluence"],
        experienceLevel: "mid",
        salaryRange: "$70,000 - $90,000",
        location: "Remote",
        status: "active",
        order: 10,
        tags: ["documentation", "writing", "content"],
      },
      {
        title: "Cloud Architect",
        slug: "cloud-architect",
        description: "Design and oversee our company's cloud computing strategy, including cloud adoption plans, cloud application design, and cloud management.",
        skills: ["Azure", "GCP", "AWS", "CloudFormation", "Security"],
        experienceLevel: "senior",
        salaryRange: "$150,000 - $200,000",
        location: "Dallas, TX",
        status: "active",
        order: 11,
        tags: ["cloud", "architecture", "azure", "gcp"],
      },
      {
        title: "Cybersecurity Analyst",
        slug: "cybersecurity-analyst",
        description: "Protect our systems and networks from cyber threats. Monitor, detect, investigate, and respond to security incidents.",
        skills: ["SIEM", "Penetration Testing", "Firewalls", "Incident Response"],
        experienceLevel: "mid",
        salaryRange: "$90,000 - $125,000",
        location: "Washington, D.C.",
        status: "active",
        order: 12,
        tags: ["security", "cybersecurity", "infosec"],
      },
      {
        title: "Database Administrator",
        slug: "database-administrator",
        description: "Manage, maintain, and secure our company databases, ensuring high levels of performance and availability.",
        skills: ["SQL Server", "MySQL", "PostgreSQL", "Backup & Recovery", "Performance Tuning"],
        experienceLevel: "senior",
        salaryRange: "$95,000 - $130,000",
        location: "Raleigh, NC",
        status: "closed",
        order: 13,
        tags: ["dba", "database", "sql"],
      },
      {
        title: "Machine Learning Engineer",
        slug: "machine-learning-engineer",
        description: "Design, build, and deploy machine learning models into production. Bridge the gap between data science and software engineering.",
        skills: ["Python", "PyTorch", "Kubeflow", "Docker", "MLOps"],
        experienceLevel: "mid",
        salaryRange: "$125,000 - $170,000",
        location: "Palo Alto, CA",
        status: "active",
        order: 14,
        tags: ["ml", "ai", "engineering"],
      },
      {
        title: "Digital Marketing Specialist",
        slug: "digital-marketing-specialist",
        description: "Plan and execute all digital marketing campaigns, including SEO/SEM, email, social media, and display advertising.",
        skills: ["SEO", "SEM", "Google Analytics", "Content Marketing", "Email Marketing"],
        experienceLevel: "entry",
        salaryRange: "$55,000 - $75,000",
        location: "Remote",
        status: "active",
        order: 15,
        tags: ["marketing", "seo", "digital", "remote"],
      },
      {
        title: "Graphic Designer",
        slug: "graphic-designer",
        description: "Create visually stunning assets for marketing materials, social media, and our website. A strong portfolio is required.",
        skills: ["Adobe Illustrator", "Photoshop", "InDesign", "Branding", "Typography"],
        experienceLevel: "mid",
        salaryRange: "$60,000 - $85,000",
        location: "Los Angeles, CA",
        status: "active",
        order: 16,
        tags: ["design", "creative", "branding"],
      },
      {
        title: "IT Support Specialist",
        slug: "it-support-specialist",
        description: "Provide technical assistance and support for incoming queries and issues related to computer systems, software, and hardware.",
        skills: ["Help Desk", "Active Directory", "Office 365", "Troubleshooting"],
        experienceLevel: "entry",
        salaryRange: "$50,000 - $70,000",
        location: "Denver, CO",
        status: "active",
        order: 17,
        tags: ["it", "support", "helpdesk"],
      },
      {
        title: "Game Developer",
        slug: "game-developer",
        description: "Join our studio to create exciting and innovative games. Strong experience with Unity or Unreal Engine is essential.",
        skills: ["Unity", "C#", "3D Modeling", "Game Physics", "Unreal Engine"],
        experienceLevel: "mid",
        salaryRange: "$80,000 - $120,000",
        location: "Montreal, QC",
        status: "active",
        order: 18,
        tags: ["gaming", "unity", "development"],
      },
      {
        title: "Blockchain Developer",
        slug: "blockchain-developer",
        description: "Develop and maintain our decentralized applications (dApps) and smart contracts on the Ethereum blockchain.",
        skills: ["Solidity", "Ethereum", "Web3.js", "Truffle", "Smart Contracts"],
        experienceLevel: "senior",
        salaryRange: "$140,000 - $190,000",
        location: "Remote",
        status: "active",
        order: 19,
        tags: ["blockchain", "crypto", "web3", "remote"],
      },
      {
        title: "Data Analyst",
        slug: "data-analyst",
        description: "Interpret data, analyze results using statistical techniques, and provide ongoing reports to support business decisions.",
        skills: ["SQL", "Excel", "Tableau", "Python", "Data Visualization"],
        experienceLevel: "entry",
        salaryRange: "$65,000 - $85,000",
        location: "Atlanta, GA",
        status: "active",
        order: 20,
        tags: ["data", "analytics", "business-intelligence"],
      },
      {
        title: "Scrum Master",
        slug: "scrum-master",
        description: "Facilitate Agile/Scrum ceremonies, remove impediments for the development team, and foster an environment of continuous improvement.",
        skills: ["Scrum", "Agile", "JIRA", "Coaching", "Servant Leadership"],
        experienceLevel: "mid",
        salaryRange: "$95,000 - $125,000",
        location: "Remote",
        status: "active",
        order: 21,
        tags: ["agile", "scrum", "project-management"],
      },
      {
        title: "Sales Engineer",
        slug: "sales-engineer",
        description: "Combine technical knowledge with sales skills to provide advice and support on a range of products, for which a certain level of expertise is needed.",
        skills: ["Salesforce", "Technical Demos", "Solution Selling", "Communication"],
        experienceLevel: "mid",
        salaryRange: "$100,000 - $140,000 OTE",
        location: "Various",
        status: "active",
        order: 22,
        tags: ["sales", "tech-sales", "pre-sales"],
      },
      {
        title: "Customer Success Manager",
        slug: "customer-success-manager",
        description: "Build strong relationships with customers, ensure they are successful with our product, and drive adoption and retention.",
        skills: ["Relationship Management", "SaaS", "Onboarding", "Zendesk"],
        experienceLevel: "mid",
        salaryRange: "$70,000 - $95,000",
        location: "Dublin, Ireland",
        status: "active",
        order: 23,
        tags: ["customer-success", "saas", "account-management"],
      },
      {
        title: "HR Manager",
        slug: "hr-manager",
        description: "Oversee all aspects of human resources practices and processes, including recruitment, employee relations, and performance management.",
        skills: ["Recruiting", "Onboarding", "HR Policies", "Employee Relations"],
        experienceLevel: "senior",
        salaryRange: "$85,000 - $115,000",
        location: "London, UK",
        status: "closed",
        order: 24,
        tags: ["hr", "human-resources", "management"],
      },
      {
        title: "Financial Analyst",
        slug: "financial-analyst",
        description: "Provide financial insights and projections to help the company make well-informed commercial decisions. FP&A experience is a must.",
        skills: ["Financial Modeling", "Excel", "FP&A", "Forecasting", "SAP"],
        experienceLevel: "mid",
        salaryRange: "$75,000 - $100,000",
        location: "New York, NY",
        status: "active",
        order: 25,
        tags: ["finance", "analysis", "accounting"],
      },
      {
        title: "Embedded Systems Engineer",
        slug: "embedded-systems-engineer",
        description: "Design and develop software for embedded devices and systems, from small microcontrollers to large industrial equipment.",
        skills: ["C", "C++", "RTOS", "Microcontrollers", "Firmware"],
        experienceLevel: "mid",
        salaryRange: "$90,000 - $130,000",
        location: "San Diego, CA",
        status: "active",
        order: 26,
        tags: ["embedded", "iot", "firmware"],
      },
      {
        title: "Social Media Manager",
        slug: "social-media-manager",
        description: "Develop and implement our social media strategy in order to increase our online presence and improve our marketing efforts.",
        skills: ["Content Creation", "Hootsuite", "Community Management", "Analytics"],
        experienceLevel: "mid",
        salaryRange: "$60,000 - $80,000",
        location: "Remote",
        status: "active",
        order: 27,
        tags: ["marketing", "social-media", "content"],
      },
      {
        title: "Solutions Architect",
        slug: "solutions-architect",
        description: "Evaluate business needs to design and propose technical solutions. You will be the bridge between technical and business teams.",
        skills: ["System Design", "Cloud Architecture", "Stakeholder Management", "Pre-Sales"],
        experienceLevel: "senior",
        salaryRange: "$140,000 - $185,000",
        location: "Remote",
        status: "active",
        order: 28,
        tags: ["architecture", "solutions", "cloud"],
      },
      {
        title: "Mobile Developer (Android)",
        slug: "mobile-developer-android",
        description: "Craft beautiful and high-performing Android applications using Kotlin. A strong portfolio of published apps is a big plus.",
        skills: ["Kotlin", "Android SDK", "Jetpack Compose", "Java", "REST APIs"],
        experienceLevel: "mid",
        salaryRange: "$100,000 - $140,000",
        location: "Berlin, Germany",
        status: "active",
        order: 29,
        tags: ["android", "mobile", "kotlin"],
      },
      {
        title: "SEO Analyst",
        slug: "seo-analyst",
        description: "Analyze and implement strategies for content development, technical SEO, and link building to increase organic search rankings.",
        skills: ["Ahrefs", "SEMrush", "Google Search Console", "On-Page SEO", "Link Building"],
        experienceLevel: "entry",
        salaryRange: "$55,000 - $70,000",
        location: "Remote",
        status: "active",
        order: 30,
        tags: ["seo", "marketing", "analytics"],
      },
      {
        title: "Content Strategist",
        slug: "content-strategist",
        description: "Plan, develop, and manage our content marketing initiatives. You will own the editorial calendar and ensure content aligns with business goals.",
        skills: ["Content Marketing", "Copywriting", "SEO", "Editorial Planning"],
        experienceLevel: "mid",
        salaryRange: "$70,000 - $90,000",
        location: "Remote",
        status: "active",
        order: 31,
        tags: ["content", "strategy", "marketing"],
      },
      {
        title: "Business Analyst",
        slug: "business-analyst",
        description: "Bridge the gap between IT and the business using data analytics to assess processes, determine requirements and deliver data-driven recommendations.",
        skills: ["Requirements Gathering", "SQL", "Agile", "Process Modeling", "Visio"],
        experienceLevel: "mid",
        salaryRange: "$80,000 - $105,000",
        location: "Toronto, ON",
        status: "closed",
        order: 32,
        tags: ["business-analysis", "agile", "data"],
      },
      {
        title: "Network Engineer",
        slug: "network-engineer",
        description: "Maintain and administer our computer networks and related computing environments including systems software, applications software, and configurations.",
        skills: ["Cisco", "Routing", "Switching", "Firewalls", "VPN"],
        experienceLevel: "mid",
        salaryRange: "$85,000 - $115,000",
        location: "Phoenix, AZ",
        status: "active",
        order: 33,
        tags: ["network", "it", "cisco"],
      },
      {
        title: "Product Owner",
        slug: "product-owner",
        description: "Represent the customer's voice, manage the product backlog, and ensure the development team delivers maximum value to the business.",
        skills: ["Agile", "Scrum", "Backlog Management", "User Stories", "JIRA"],
        experienceLevel: "mid",
        salaryRange: "$105,000 - $140,000",
        location: "Remote",
        status: "active",
        order: 34,
        tags: ["product", "agile", "scrum-master"],
      },
      {
        title: "Operations Manager",
        slug: "operations-manager",
        description: "Improve operational management systems, processes and best practices. Help the organization’s processes remain legally compliant.",
        skills: ["Process Improvement", "Project Management", "Budgeting", "Leadership"],
        experienceLevel: "senior",
        salaryRange: "$90,000 - $120,000",
        location: "Philadelphia, PA",
        status: "active",
        order: 35,
        tags: ["operations", "management", "logistics"],
      },
      {
        title: "Animator",
        slug: "animator",
        description: "Create 2D and 3D animations for our products, marketing videos, and social media content. Strong skills in After Effects and Blender required.",
        skills: ["Adobe After Effects", "Blender", "Maya", "2D Animation", "3D Animation"],
        experienceLevel: "mid",
        salaryRange: "$65,000 - $90,000",
        location: "Remote",
        status: "active",
        order: 36,
        tags: ["animation", "creative", "motion-graphics"],
      },
      {
        title: "E-commerce Manager",
        slug: "e-commerce-manager",
        description: "Oversee our online sales and presence. Responsible for the entire e-commerce P&L, from traffic generation to conversion and fulfillment.",
        skills: ["Shopify", "Google Analytics", "PPC", "Conversion Rate Optimization (CRO)"],
        experienceLevel: "senior",
        salaryRange: "$95,000 - $130,000",
        location: "Miami, FL",
        status: "active",
        order: 37,
        tags: ["ecommerce", "marketing", "shopify"],
      },
      {
        title: "Java Developer",
        slug: "java-developer",
        description: "Design, develop, and manage Java-based applications and services. Experience with the Spring Framework is essential.",
        skills: ["Java", "Spring Boot", "Hibernate", "Maven", "Microservices"],
        experienceLevel: "senior",
        salaryRange: "$110,000 - $150,000",
        location: "Remote",
        status: "active",
        order: 38,
        tags: ["java", "backend", "spring"],
      },
      {
        title: "Ruby on Rails Developer",
        slug: "ruby-on-rails-developer",
        description: "Build and maintain scalable web applications using Ruby on Rails. We value clean, maintainable code and robust testing.",
        skills: ["Ruby", "Rails", "RSpec", "Sidekiq", "PostgreSQL"],
        experienceLevel: "mid",
        salaryRange: "$90,000 - $125,000",
        location: "Portland, OR",
        status: "closed",
        order: 39,
        tags: ["ruby", "rails", "backend"],
      },
      {
        title: "Systems Administrator",
        slug: "systems-administrator",
        description: "Responsible for the maintenance, configuration, and reliable operation of computer systems and servers.",
        skills: ["Linux", "Windows Server", "Bash Scripting", "Active Directory", "VMware"],
        experienceLevel: "mid",
        salaryRange: "$75,000 - $100,000",
        location: "Houston, TX",
        status: "active",
        order: 40,
        tags: ["sysadmin", "it", "linux"],
      },
      {
        title: "Legal Counsel",
        slug: "legal-counsel",
        description: "Provide legal advice and guidance on all matters affecting the company, including contracts, compliance, and corporate governance.",
        skills: ["Corporate Law", "Contract Negotiation", "Compliance", "Data Privacy"],
        experienceLevel: "senior",
        salaryRange: "$150,000 - $220,000",
        location: "San Francisco, CA",
        status: "active",
        order: 41,
        tags: ["legal", "corporate", "counsel"],
      },
      {
        title: "Recruiter",
        slug: "recruiter",
        description: "Manage the full life-cycle recruiting process to meet the various staffing goals across all levels within multiple business units.",
        skills: ["Sourcing", "Interviewing", "Applicant Tracking Systems (ATS)", "Negotiation"],
        experienceLevel: "mid",
        salaryRange: "$65,000 - $90,000",
        location: "Remote",
        status: "active",
        order: 42,
        tags: ["recruiting", "hr", "talent-acquisition"],
      },
    ]);

  }
}

//  Reset and reseed candidates with deterministic data
export async function resetCandidates() {
  // Clear existing candidates and timelines
  await db.candidates.clear();
  await db.timelines.clear();
  
  const fakeStages = ["applied", "screen", "tech", "offer", "hired", "rejected"];
  const availableJobs = [14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34];
  
  // Create deterministic candidates with fixed patterns
  const candidates = Array.from({ length: 1000 }).map((_, i) => {
    // Use deterministic assignment based on index
    const jobIndex = i % availableJobs.length;
    const stageIndex = i % fakeStages.length;
    
    return {
      name: `Candidate ${i + 1}`,
      email: `candidate${i + 1}@mail.com`,
      jobId: availableJobs[jobIndex],
      stage: fakeStages[stageIndex],
    };
  });

  const ids = await db.candidates.bulkAdd(candidates, { allKeys: true });

  // Add timeline entries with deterministic timestamps
  const now = Date.now();
  const timelines = ids.map((id, i) => ({
    candidateId: id,
    event: "Applied",
    createdAt: new Date(now - i * 1000 * 60).toISOString(),
  }));

  await db.timelines.bulkAdd(timelines);
}

//  Seed candidates and their timelines with deterministic data
export async function seedCandidates() {
  const count = await db.candidates.count();
  if (count === 0) {
    const fakeStages = ["applied", "screen", "tech", "offer", "hired", "rejected"];
    const availableJobs = [14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34];
    
    // Create deterministic candidates with fixed patterns
    const candidates = Array.from({ length: 1000 }).map((_, i) => {
      // Use deterministic assignment based on index
      const jobIndex = i % availableJobs.length;
      const stageIndex = i % fakeStages.length;
      
      return {
        name: `Candidate ${i + 1}`,
        email: `candidate${i + 1}@mail.com`,
        jobId: availableJobs[jobIndex],
        stage: fakeStages[stageIndex],
      };
    });

    const ids = await db.candidates.bulkAdd(candidates, { allKeys: true });

    // Add timeline entries with deterministic timestamps
    const now = Date.now();
    const timelines = ids.map((id, i) => ({
      candidateId: id,
      event: "Applied",
      createdAt: new Date(now - i * 1000 * 60).toISOString(),
    }));
    await db.timelines.bulkAdd(timelines);
  }
}
